const MusikipediaRhythmSounds=function(){"use strict";var e,t,n,o,l=!1,s=!1;return e=new Howl({src:["/ovelser/lyde/rhythm/rhythmsound.mp3","/ovelser/lyde/rhythm/rhythmsound.ogg"],preload:!0,onplay:function(e){s=!0}}),t=new Howl({src:["/ovelser/lyde/metronome/metronome1.mp3","/ovelser/lyde/metronome/metronome1.ogg","/ovelser/lyde/metronome/metronome1.wav"],preload:!0,onplay:function(e){s=!0}}),n=new Howl({src:["/ovelser/lyde/metronome/metronome2.mp3","/ovelser/lyde/metronome/metronome2.ogg","/ovelser/lyde/metronome/metronome2.wav"],preload:!0,onplay:function(e){s=!0}}),o=new Howl({src:["/ovelser/lyde/metronome/metronome2.mp3","/ovelser/lyde/metronome/metronome2.ogg","/ovelser/lyde/metronome/metronome2.wav"],preload:!0,onplay:function(e){s=!0}}),l=!1,s=!1,{allSoundsAreLoaded:function(){return!!l||(l=(l=(l=(l=(l=!0)&&"loaded"===e.state())&&"loaded"===t.state())&&"loaded"===n.state())&&"loaded"===o.state())},play:function(l,s){switch(l){case"rhythm":e.volume(s),e.play();break;case"metronomeBar":t.volume(s),t.play();break;case"metronomeBeat":n.volume(s),n.play();break;case"metronomeSubBeat":o.volume(s),o.play()}},stop:function(l){const s=l?50:500;e.fade(1,0,s),t.fade(1,0,s),n.fade(1,0,s),o.fade(1,0,s)},hasAnySoundBeenPlaying:function(){return s}}}();var MusikipediaRhythmPlayer=function(){"use strict";var e,t,n,o,l,s,a,i,u,r,d,m,h,p,c,f,y,v,g,b,k,S,T,E,B,A,O,w;
//! RHYTHM: SOUND EVENT
function C(e){this.soundType=e.soundType,this.volume=void 0!==e.volume?e.volume:1,this.functionToBeCalledOnPlay=void 0!==e.functionToBeCalledOnPlay?e.functionToBeCalledOnPlay:null,this.component=void 0!==e.component?e.component:null,this.elements=void 0!==e.elements?e.elements:null,this.endStep=void 0!==e.endStep?e.endStep:-1,this.tapped=!1,this.markedAsMissed=!1}
//! RHYTHM: METRONOME
function P(){this.steps=t.length/e,this.soundEvents=Array(this.steps);let n=t.tactusLevel,o=t.beatsOfLevel(n).length;1===o&&(n++,o=t.beatsOfLevel(n).length);const l=2*o!==t.beatsOfLevel(n+1).length,s=t.beatsOfLevel(n+(l?1:0));let a=1;for(const e of s)0===e.pos?(this.addSoundAt(e.pos,"metronomeBar",1,1),a++):e.level<=n?(this.addSoundAt(e.pos,"metronomeBeat",1,a),a++):l&&(this.addSoundAt(e.pos,"metronomeBeat",.2,a),a++)}
//! RHYTHM: SOUND SQUENCE
function L(t){this.rhythm=t,this.steps=t.bars.length*t.metricalStructure.length/e,this.soundEvents=Array(this.steps),this.addRhythmSounds(),this.markedSoundEvent=null}C.prototype.play=function(e=1){null!==this.soundType&&(MusikipediaRhythmSounds.play(this.soundType,this.volume*e),void 0!==this.functionToBeCalledOnPlay&&null!==this.functionToBeCalledOnPlay&&this.functionToBeCalledOnPlay(this))},C.prototype.markAsPlaying=function(){this.elements.forEach((e=>{new RegExp("(\\s|^)playing(\\s|$)").test(e.getAttribute("class"))||e.setAttribute("class",e.getAttribute("class")+" playing")}))},C.prototype.markAsNotPlaying=function(){this.elements.forEach((e=>{if(new RegExp("(\\s|^)playing(\\s|$)").test(e.getAttribute("class"))){const t=e.getAttribute("class").replace(new RegExp("(\\s|^)playing(\\s|$)","g"),"$2");e.setAttribute("class",t)}}))},P.prototype.addSoundAt=function(t,n,o,l){const s=new C({soundType:n,volume:o});s.beatNumber=l;const a=t/e;this.soundEvents[a]=s},P.prototype.playSoundAt=function(e){const t=e%this.steps;if(void 0!==this.soundEvents[t]){const e=this.soundEvents[t];e.play(1),null===u||"countin"!==S||"metronomeBar"!==e.soundType&&"metronomeBeat"!==e.soundType||u(e.beatNumber)}},L.prototype.addRhythmSounds=function(){let t=!1;for(let n=0;n<this.rhythm.bars.length;n++){const o=this.rhythm.bars[n].arrayOfComponents();for(const n of o){if(!t){const t=(n.positionOfSound(this.rhythm.metricalStructure)+this.rhythm.metricalStructure.length*n.barNumber)/e,o=this.rhythm.durationOfComponentStartingAt(n.barNumber,n.position);n.rest?this.soundEvents[t]=new C({soundType:null,component:n,elements:void 0===this.rhythm.elementsOf?void 0:this.rhythm.elementsOf(n.barNumber,n.position),endStep:t+o/e}):this.soundEvents[t]=new C({soundType:"rhythm",component:n,elements:void 0===this.rhythm.elementsOf?void 0:this.rhythm.elementsOf(n.barNumber,n.position),endStep:t+o/e})}t=n.endsWithATie()}}},L.prototype.playSoundAt=function(e){void 0!==this.soundEvents[e]&&this.soundEvents[e].play()},L.prototype.markElementsAt=function(e){null!==this.markedSoundEvent&&this.markedSoundEvent.endStep<=e&&(this.markedSoundEvent.markAsNotPlaying(),this.markedSoundEvent=null),void 0!==this.soundEvents[e]&&this.soundEvents[e].elements&&this.soundEvents[e].elements.length>0&&(null!==this.markedSoundEvent&&this.markedSoundEvent.markAsNotPlaying(),this.markedSoundEvent=this.soundEvents[e],this.markedSoundEvent.markAsPlaying())},L.prototype.markAsNotPlaying=function(){null!==this.markedSoundEvent&&(this.markedSoundEvent.markAsNotPlaying(),this.markedSoundEvent=null)},L.prototype.setAllToUntapped=function(){for(const e of this.soundEvents)void 0!==e&&(e.tapped=!1,e.markedAsMissed=!1)},L.prototype.nearestSoundEvent=function(e){let t=null,n=Math.round(e),o=0;for(;;){if(n>=0&&n<this.soundEvents.length){if(void 0!==this.soundEvents[n]&&null!==this.soundEvents[n].soundType){t=this.soundEvents[n];break}}else if(n<0&&n>=this.soundEvents.length)break;o=0===o?n>Math.floor(e)?-1:1:o>0?-o-1:1-o,n+=o}return t}
//! RHYTHM PLAYER;
function N(){null!==m&&("shutdown"==S?m.style.display="none":(m.src=null===r?"/ovelser/grafik/ikoner/afspillyd.png":"/ovelser/grafik/ikoner/lydafspilles.png",m.style.display="inline"))}function M(){s&&s("countin",S),B=0,S="countin"}function R(){s&&s("play",S),B=0,w=!1,S="play",T=!1}function I(){null!==f&&f.setAllToUntapped(),s&&s("tap",S),B=0,w=!1,S="tap",T=!1}function W(){s&&s("countout",S),B=0,S="countout"}function D(){if("play"===S&&f.playSoundAt(B),null!==c&&c.playSoundAt(B),g&&(O=performance.now(),A="tap"===S?B:"countin"===S?B-t.length/e:B-f.steps),0===B?(null!==l&&l(S),T&&null!==a&&a(),null!==d&&"play"===S&&d.removeAllLabels()):"countin"===S&&B>=t.length/e/2&&null!==i&&i(),0===B&&f.markAsNotPlaying(),"play"===S&&f.markElementsAt(B),"tap"===S&&(b&&f.markElementsAt(B),function(){if(null!==f){const n=6e4/t.tempo/t.timeSignature.length,o=e*n;let l=Math.floor(B-250/o);for(;l>=0;){if(void 0!==f.soundEvents[l]){if(f.soundEvents[l].tapped)break;null!==d&&null!==f.soundEvents[l].soundType&&(f.soundEvents[l].markedAsMissed||(d.showLabelOnComponent(f.soundEvents[l].component,"÷"),f.soundEvents[l].markedAsMissed=!0),w=!0)}l--}}}()),null!==c)switch(B++,S){case"countin":if(T=!1,B>=c.steps)if(v)R();else{if(!g)return void V();d.removeAllLabels(),I()}break;case"play":if(T=!1,B>=f.steps)if(g)I();else{if(!k)return void V();W()}break;case"tap":T=!0,B>=f.steps&&(k?W():M());break;case"countout":T=!1,B>=c.steps&&M()}else V()}function H(n){const o=performance.now();MusikipediaRhythmSounds.play("rhythm",p);const l=6e4/t.tempo/t.timeSignature.length,s=e*l,a=o-O,i=A+a/s,u=f.nearestSoundEvent(i),r=u.component,m=a-((r.barNumber*t.length+r.positionOfSound(t))/e-A)*s,c=t.isOnTactusBeat(r.position);if(null!==d)if(m<(c?h.afterTactusBeat:h.afterOtherBeat)&&m>(c?-h.beforeTactusBeat:-h.beforeOtherBeat))d.showLabelOnComponent(r,"√"),u.tapped=!0;else{w=!0;const n=Math.floor(i*e/t.length),o=i*e-n*t.length,l=t.visualPositionOfSoundPosition(o);d.showLabelForUnknownTab(n,l),Math.abs(m)<300&&(u.tapped=!0)}}function x(){MusikipediaRhythmSounds.hasAnySoundBeenPlaying()?(r=setInterval(D,E),N()):setTimeout(x,100)}function U(){if("shutdown"!=S)if(MusikipediaRhythmSounds.allSoundsAreLoaded()){clearTimeout(r),y?M():R();const n=6e4/t.tempo/t.timeSignature.length;E=e*n,D(),x()}else setTimeout(startWhenAllSoundsAreLoaded,200)}var V=function(){clearTimeout(r),r=null,S="stop",T=!1,N(),null!==f&&f.markAsNotPlaying(),null!==o&&o()};function F(){null!==r?V():"shutdown"!=S&&(null!==n&&n(),null!==d&&d.removeAllLabels(),U())}function j(){F()}function q(e){e.repeat||("Space"===e.code||" "===e.key?"tap"===S?H():null===r&&"none"!=m.style.display&&F():null===m||"s"!==e.code&&"s"!==e.key||F())}return{initialisation:function(E){e=void 0===E.unitsPerStep?24:E.unitsPerStep,t=void 0===E.metricalStructure?null:E.metricalStructure,n=void 0===E.beforePlayingCallback?null:E.beforePlayingCallback,o=void 0===E.afterStoppingCallback?null:E.afterStoppingCallback,l=void 0===E.changeStatusCallback?null:E.changeStatusCallback,s=void 0===E.beforeChangeStatusCallback?null:E.beforeChangeStatusCallback,u=void 0===E.countInCallback?null:E.countInCallback,a=void 0===E.finishedTappingCallback?null:E.finishedTappingCallback,i=void 0===E.halfwayThroughCountIn?null:E.halfwayThroughCountIn,p=void 0===E.tapVolume?.44:E.tapVolume,d=void 0===E.rhythmImage?null:E.rhythmImage,r=null,E.elementWithButton?((m=document.createElement("img")).width=32,m.height=32,m.style.display="none",E.elementWithButton.appendChild(m),m.addEventListener("click",j),N()):m=null,h={},E.tapToleranceLimits?(h.beforeTactusBeat=E.tapToleranceLimits.beforeTactusBeat,h.beforeOtherBeat=E.tapToleranceLimits.beforeOtherBeat,h.afterTactusBeat=E.tapToleranceLimits.afterTactusBeat,h.afterOtherBeat=E.tapToleranceLimits.afterOtherBeat):(h.beforeTactusBeat=90,h.beforeOtherBeat=40,h.afterTactusBeat=90,h.afterOtherBeat=40),(null!==m||g)&&document.addEventListener("keydown",q),c=null!==t?new P:null,f=null,y=void 0===E.includeCountIn||E.includeCountIn,v=void 0===E.includePlaying||E.includePlaying,g=void 0!==E.includeTapping&&E.includeTapping,b=void 0!==E.markNotesDuringTapping&&E.markNotesDuringTapping,k=void 0!==E.includeCountOut&&E.includeCountOut,!0,B=0,S="stop",T=!1},setRhythm:function(e){"stop"!=S&&"countin"!=S&&"countout"!=S||(t=e.metricalStructure,c=new P,null!==f&&f.markAsNotPlaying(),f=new L(e))},play:function(){"shutdown"!=S&&(null!==n&&n(),U())},stop:V,hideButton:function(){m.style.display="none"},showButton:N,atLeastOneNoteWasWrongDuringTapping:function(){return w},tap:function(){"tap"===S?H(event):"stop"===S&&F()},skipCountOut:function(){"countout"===S&&(s&&s("countin",S),S="countin")},setToleranceLimits:function(e){void 0!==e.tapToleranceLimits&&(h.beforeTactusBeat=e.tapToleranceLimits),void 0!==e.beforeOtherBeat&&(h.beforeOtherBeat=e.beforeOtherBeat),void 0!==e.afterTactusBeat&&(h.afterTactusBeat=e.afterTactusBeat),void 0!==e.afterOtherBeat&&(h.afterOtherBeat=e.afterOtherBeat)},setMarkNotesDuringTapping:function(e){b=e},removeMetronome:function(){c=null},shutDown:function(){V(),c=null,t=null,f=null,n=null,o=null,l=null,s=null,u=null,a=null,i=null,d=null,S="shutdown"}}}();